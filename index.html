<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Подбор стекла</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --pad: 16px;

      /* светлая тема по умолчанию */
      --card: rgba(255,255,255,.80);
      --cardBorder: rgba(0,0,0,.10);
      --text: #0f172a;
      --muted: rgba(15,23,42,.65);
      --inputBg: rgba(255,255,255,.92);
      --inputBorder: rgba(0,0,0,.14);
      --shadow: 0 18px 45px rgba(0,0,0,.10);

      /* зелёно-синий акцент */
      --accent1: #16a34a; /* green */
      --accent2: #06b6d4; /* cyan */
    }

    /* тёмная тема */
    @media (prefers-color-scheme: dark){
      :root{
        --card: rgba(17,24,39,.74);
        --cardBorder: rgba(255,255,255,.12);
        --text: #f9fafb;
        --muted: rgba(249,250,251,.65);
        --inputBg: rgba(17,24,39,.70);
        --inputBorder: rgba(255,255,255,.16);
        --shadow: 0 22px 70px rgba(0,0,0,.55);

        --accent1: #22c55e;
        --accent2: #22d3ee;
      }
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      padding:
        calc(var(--pad) + env(safe-area-inset-top, 0px))
        calc(var(--pad) + env(safe-area-inset-right, 0px))
        calc(var(--pad) + env(safe-area-inset-bottom, 0px))
        calc(var(--pad) + env(safe-area-inset-left, 0px));

      /* ФОН: клетка + зелёно-синий градиент */
      background:
        /* мелкая клетка */
        linear-gradient(rgba(255,255,255,.22) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.22) 1px, transparent 1px),

        /* крупная клетка (еле заметная) */
        linear-gradient(rgba(255,255,255,.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.10) 1px, transparent 1px),

        /* градиент */
        radial-gradient(900px 600px at 15% 10%, rgba(34,197,94,.32), transparent 58%),
        radial-gradient(900px 600px at 85% 15%, rgba(34,211,238,.30), transparent 55%),
        linear-gradient(180deg, #eafff4, #e8fbff);

      background-size:
        16px 16px,
        16px 16px,
        64px 64px,
        64px 64px,
        auto,
        auto,
        auto;
      background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0, 0 0;
    }

    /* фон в тёмной теме — та же клетка, но темнее */
    @media (prefers-color-scheme: dark){
      body{
        background:
          linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px),

          linear-gradient(rgba(255,255,255,.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px),

          radial-gradient(900px 600px at 15% 10%, rgba(34,197,94,.22), transparent 58%),
          radial-gradient(900px 600px at 85% 15%, rgba(34,211,238,.18), transparent 55%),
          linear-gradient(180deg, #071a14, #061821);

        background-size:
          16px 16px, 16px 16px,
          64px 64px, 64px 64px,
          auto, auto, auto;
      }
    }

    .wrap{ max-width: 540px; margin: 0 auto; }

    .header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .title{
      margin: 0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
    }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--cardBorder);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(10px);
      color: var(--muted);
      white-space: nowrap;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      padding: 14px;
    }

    .subtitle{
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    .field{
      display: grid;
      grid-template-columns: 1fr 92px;
      gap: 12px;
      align-items: end;
      margin-top: 12px;
    }

    .labelRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    label{
      font-weight: 700;
      font-size: 13px;
      letter-spacing: .2px;
    }

    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--cardBorder);
      color: var(--muted);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(10px);
    }

    .input{
      width: 100%;
      padding: 12px 12px;
      font-size: 16px;
      border-radius: 14px;
      border: 1px solid var(--inputBorder);
      background: var(--inputBg);
      outline: none;
      transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease;
    }

    .input:focus{
      border-color: rgba(6,182,212,.55);
      box-shadow: 0 0 0 4px rgba(6,182,212,.18);
      transform: translateY(-1px);
    }

    .hintimg{
      width: 92px;
      height: 60px;
      border-radius: 14px;
      border: 1px solid var(--cardBorder);
      object-fit: contain;
      background: rgba(255,255,255,.55);
      padding: 6px;
    }

    .note{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--cardBorder);
      background: linear-gradient(90deg, rgba(34,197,94,.14), rgba(34,211,238,.12));
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .note b{ color: var(--text); }

    /* ✅ новая строка "Округлено..." */
    .roundedLine{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(6,182,212,.45);
      background: rgba(6,182,212,.08);
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .roundedLine b{ color: var(--text); }

    .actions{ margin-top: 14px; }

    .btn{
      width: 100%;
      border: 0;
      cursor: pointer;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 800;
      border-radius: 16px;
      color: white;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      box-shadow: 0 14px 30px rgba(6,182,212,.18);
      transition: transform .08s ease, filter .15s ease;
    }

    .btn:active{
      transform: translateY(1px) scale(.995);
      filter: brightness(.97);
    }

    .helper{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      line-height: 1.35;
    }

    @media (max-width: 360px){
      .field{ grid-template-columns: 1fr; }
      .hintimg{ width: 100%; height: 110px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h3 class="title">Подбор стекла по размеру</h3>
      <div class="pill">быстрый поиск</div>
    </div>

    <div class="card">
      <p class="subtitle">
        Введите размеры стекла в мм. Значения автоматически округляются до <b>0,5 мм</b>.
      </p>

      <div class="field">
        <div>
          <div class="labelRow">
            <label for="h">Длина (мм)</label>
            <span class="badge">↑↓</span>
          </div>
          <input class="input" id="h" inputmode="decimal" placeholder="Напр. 155 или 155,5">
        </div>
        <img class="hintimg" src="img/length.png" alt="Где измерять длину стекла">
      </div>

      <div class="field">
        <div>
          <div class="labelRow">
            <label for="w">Ширина (мм)</label>
            <span class="badge">←→</span>
          </div>
          <input class="input" id="w" inputmode="decimal" placeholder="Напр. 72 или 72,5">
        </div>
        <img class="hintimg" src="img/width.png" alt="Где измерять ширину стекла">
      </div>

      <div class="note">
        ℹ️ Пример округления: 155,2 → 155; 155,3 → 155,5.
      </div>

      <!-- ✅ новая строка статуса округления -->
      <div class="roundedLine" id="roundedLine">
        Округлено: <b>—</b>
      </div>

      <div class="actions">
        <button class="btn" id="btn">Найти стекло</button>
        <div class="helper">После нажатия форма закроется, и бот покажет результаты.</div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    if (!tg) {
      console.warn("Telegram.WebApp недоступен. Откройте страницу через кнопку в Telegram.");
    } else {
      try { tg.ready(); } catch(e) {}
      try { tg.expand(); } catch(e) {}
    }

    const hInput = document.getElementById('h');
    const wInput = document.getElementById('w');
    const roundedLine = document.getElementById('roundedLine');

    function parseNumber(val) {
      const s = (val || '').toString().trim().replace(',', '.');
      const x = Number(s);
      return Number.isFinite(x) ? x : null;
    }

    function roundToHalf(x) {
      return Math.round(x * 2) / 2;
    }

    function formatRuNumber(x) {
      const isInt = Math.abs(x - Math.round(x)) < 1e-9;
      return isInt ? String(Math.round(x)) : String(x).replace('.', ',');
    }

    function normalizeInput(el) {
      const x = parseNumber(el.value);
      if (x === null) return null;
      const r = roundToHalf(x);
      el.value = formatRuNumber(r);
      return r;
    }

    // ✅ обновление строки "Округлено"
    function updateRoundedPreview() {
      const h = parseNumber(hInput.value);
      const w = parseNumber(wInput.value);

      const hTxt = (h === null) ? "—" : formatRuNumber(roundToHalf(h));
      const wTxt = (w === null) ? "—" : formatRuNumber(roundToHalf(w));

      roundedLine.innerHTML = `Округлено: <b>${hTxt} × ${wTxt} мм</b>`;
    }

    // обновляем при вводе (без изменения значения в поле)
    hInput.addEventListener('input', updateRoundedPreview);
    wInput.addEventListener('input', updateRoundedPreview);

    // а при потере фокуса — ещё и подменяем значение на округлённое
    hInput.addEventListener('blur', () => { normalizeInput(hInput); updateRoundedPreview(); });
    wInput.addEventListener('blur', () => { normalizeInput(wInput); updateRoundedPreview(); });

    // начальное состояние
    updateRoundedPreview();

    document.getElementById('btn').addEventListener('click', () => {
      const hVal = normalizeInput(hInput);
      const wVal = normalizeInput(wInput);
      updateRoundedPreview();

      if (hVal === null || wVal === null) {
        alert('Введите длину и ширину числами (можно с запятой).');
        return;
      }

      // ✅ источник для аналитики (menu/cmd/unknown)
      const src = new URLSearchParams(window.location.search).get('src') || 'unknown';

      const payload = { height: hVal, width: wVal, src };

      console.log('WebApp: sendData ->', payload);

      if (!tg) {
        alert("Откройте форму через Telegram-кнопку, чтобы отправить данные боту.");
        return;
      }

      try {
        tg.sendData(JSON.stringify(payload));
        setTimeout(() => {
          try { tg.close(); } catch(e) {}
        }, 250);
      } catch (err) {
        console.error('Ошибка sendData:', err);
        alert('Ошибка отправки данных. Попробуйте снова.');
      }
    });
  </script>
</body>
</html>
